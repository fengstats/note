## å‰è¨€

- [é…ç½®ä¸€å±‚ nginx ä»£ç†éªŒè¯](https://cloud.tencent.com/developer/article/1678213)
- [GitHub - hr3lxphr6j/bililive-go](https://github.com/hr3lxphr6j/bililive-go) - åŠç³–å“¥æ¨è
- [qjfoidnh/BaiduPCS-Go](https://github.com/qjfoidnh/BaiduPCS-Go) - åŠç³–å“¥æ¨è

> ç¬‘æ­»äº† 7 å“¥æ¨èçš„éƒ½æ²¡ç”¨è¿‡

- [GitHub - BililiveRecorder/BililiveRecorder](https://github.com/BililiveRecorder/BililiveRecorder/tree/dev?tab=readme-ov-file) - 7 å“¥æ¨èï¼ˆTODOï¼‰
- [houtianze/bypy](https://github.com/houtianze/bypy) - 7 å“¥æ¨èï¼ˆTODOï¼‰

## FFmpeg âœ…

```bash
sudo apt-get install ffmpeg
```

## bililive-go é•œåƒå¯åŠ¨ âœ…

æ‹‰å– docker é•œåƒ

```bash
docker pull chigusa/bililive-go
```

å¯åŠ¨ docker å®¹å™¨æœåŠ¡

```bash
docker run --restart=always \
-v ~/config.yml:/home/feng/config/bililive-go/config.yml \
-v ~/Videos:/home/feng/videos/bililive-go \
-p 8080:8080 -d chigusa/bililive-go
```

## bililive-go ç»ˆç«¯å¯åŠ¨ âœ…

æ‰“å¼€ [Bililive-go Releases](https://github.com/hr3lxphr6j/bililive-go/releases/latest)ï¼Œä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬å¹¶è§£å‹ï¼Œæˆ‘æ˜¯ Ubuntu é€‰æ‹©çš„æ˜¯

- linux-amd64 ç‰ˆæœ¬
- linux-386 ç‰ˆæœ¬

æŠŠå¯æ‰§è¡Œæ–‡ä»¶æ”¹ä¸ªåå­—

```bash
mv [filename] [renameFile]

mv bililive-linux-386 bililive
```

ç›´æ¥å¯åŠ¨

```bash
./bililive
```

é…ç½®ä¸ºç³»ç»ŸæœåŠ¡å¯åŠ¨ï¼ˆå¯é€‰ï¼‰

```bash
echo "[Unit]
Description=Live Stream Saver
Wants=network-online.target
After=network-online.target
[Service]
Type=simple
ExecStart=/home/feng/config/bililive-go/bililive -c /home/feng/config/bililive-go/config.yml
Restart=on-failure
[Install]
WantedBy=multi-user.target" > /usr/lib/systemd/system/bililive-go.service
```

å¯åŠ¨ï¼ï¼ï¼

```bash
# é‡æ–°åŠ è½½è¿›ç¨‹æœåŠ¡
systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
systemctl enable bililive-go.service

# å¯åŠ¨æœåŠ¡
systemctl start bililive-go.service
```

## é…ç½®ä¸€å±‚ nginx ä»£ç†éªŒè¯ âœ…

å®‰è£… nginx

```bash
sudo apt update
sudo apt install nginx
```

åˆ›å»ºå¯†ç æ–‡ä»¶

```bash
sudo apt install apache2-utils
```

æ·»åŠ ç”¨æˆ·ï¼ˆå›è½¦åä¼šæç¤ºè¾“å…¥å¯†ç ï¼‰

```bash
sudo htpasswd -c /etc/nginx/htpasswd fengstats
```

é…ç½® nginx æ–‡ä»¶

```bash
server {
    location / {
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/htpasswd;
        proxy_pass http://localhost:8080;
    }
}
```

é‡å¯ nginx æœåŠ¡

```bash
sudo systemctl restart nginx
```

## æ— æ³•ç›´æ¥åœ¨ç½‘é¡µé¢„è§ˆè§†é¢‘ âœ…

å¯ä»¥çœ‹åˆ°è¯·æ±‚æ–‡ä»¶æ—¶ç›´æ¥ 404 äº†ï¼Œæ˜¯ä¸æ˜¯éœ€è¦æŠŠå¯¹åº”çš„æ–‡ä»¶æœåŠ¡æš´éœ²å‡ºå»ï¼Ÿ

![1713975773147.png](https://cdn.jsdelivr.net/gh/fengstats/blogcdn@main/2024/1713975773147.png)

å°è¯•æ›´æ”¹é…ç½®ï¼Œå°† `flv` æ–‡ä»¶åœ¨å½•åˆ¶åè½¬æ¢ä¸º `mp4` æ–‡ä»¶ï¼ˆè¿˜æ˜¯ä¸è¡Œï¼‰

```bash
on_record_finished:
  # å½•åˆ¶å®Œæˆåè½¬æ¢æˆ mp4
  convert_to_mp4: true
  # åˆ é™¤ flv
  delete_flv_after_convert: true
  # å‘½ä»¤å½¢å¼
  # custom_commandline: '{{ .Ffmpeg }} -hide_banner -i "{{ .FileName }}" -c copy "{{ .FileName | trimSuffix (.FileName | ext)}}.mp4"'
```

å‘ç° `files/` è·¯å¾„ä¸‹ä¸º `/` ç›®å½•çš„æ–‡ä»¶ä¿¡æ¯ï¼Œæ‰€ä»¥æ²¡æ‰¾åˆ°ï¼Œæ­£å¸¸æœç´¢ `/home/feng/config/xxx` æ˜¯å¯è¡Œçš„

![1714030201800.png](https://cdn.jsdelivr.net/gh/fengstats/blogcdn@main/2024/1714030201800.png)

å¯èƒ½ä¹‹å‰æ”¹äº† `out_put_path`ï¼Œçœ‹åˆ°æ–‡ä»¶å­˜å‚¨ä½ç½®æ­£ç¡®åå°±æ²¡ç®¡äº†ï¼Œä½†æ˜¯æ²¡é‡æ–°å¯åŠ¨ `bililive-go.service`ï¼Œè¿™é‡Œå°è¯•é‡æ–°å¯åŠ¨ âœ…

```bash
systemctl restart bililive-go.service
```

å¯æ¶ï¼Œé‡å¯æœç„¶èƒ½è§£å†³ 99% çš„é—®é¢˜

## BaiduPCS-Go ä¸Šä¼ ç™¾åº¦äº‘è§†é¢‘ âœ…

macOS æœ¬åœ°æµ‹è¯•ï¼Œä¸‹è½½ darwin-arm64 ç‰ˆæœ¬ï¼Œè§£å‹åç›´æ¥æ‰§è¡Œ

```bash
./BaiduPCS-Go
```

è·å– BDUSS ç”¨äºç™»å½•

![1714049981828.png](https://cdn.jsdelivr.net/gh/fengstats/blogcdn@main/2024/1714049981828.png)

```bash
login -bduss=1234567
```

ä¸Šä¼ ç›®å½•æ–‡ä»¶

```bash
# ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶
# /test æ˜¯ä»æ ¹ç›®å½•å¼€å§‹çš„
upload /Users/feng/codebase/workspace/video-upload/compress.mp4 /test

# ä¸Šä¼ æ•´ä¸ªç›®å½•
upload /Users/feng/codebase/workspace/video-upload /BaiduPCS-Go

# ç®€å†™å‘½ä»¤
u /Users/feng/codebase/workspace/video-upload /BaiduPCS-Go
```

æœåŠ¡å™¨

```bash
u /home/feng/config/bililive-go/å“”å“©å“”å“©/å°å°å°çŸ³å‘€/2024-04-24-xiaoDong.flv /BaiduPCS-Go

u /home/feng/config/bililive-go/å“”å“©å“”å“©/å°å°å°çŸ³å‘€ /BaiduPCS-Go
```

é“¾æ¥æœ¬åœ°å¯æ‰§è¡Œç›®å½•ä½ç½®

![1714055118642.png](https://cdn.jsdelivr.net/gh/fengstats/blogcdn@main/2024/1714055118642.png)

```bash
ln [å½“å‰å¯æ‰§è¡Œæ–‡ä»¶ä½ç½®] /usr/local/bin/[éšæ„å–åä¸€ä¸ªæ–°çš„å¯æ‰§è¡Œæ–‡ä»¶åç§°]

# ç„¶åå°±å¯ä»¥ç›´æ¥åœ¨ä»»æ„åœ°æ–¹ä½¿ç”¨ä½ å‘½åçš„è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶äº†
```

### unzip å‘½ä»¤è§£å‹ âœ…

å®‰è£…

```bash
apt install unzip
```

è§£å‹

```bash
unzip [éœ€è¦è§£å‹çš„å‹ç¼©åŒ…]
```

## shell è„šæœ¬ä¸Šä¼  âœ…

upload.sh

```bash
#!/bin/bash

current_date=$(date "+%Y-%m-%d")
# current_date="test"

# è®¾ç½®éœ€è¦ä¸Šä¼ çš„ç›®å½•
local_directory="/home/feng/config/bililive-go/å“”å“©å“”å“©/å°å°å°çŸ³å‘€/$current_date"
# local_directory="/home/feng/config/bililive-go/å“”å“©å“”å“©/è¯¥ç”¨æˆ·ä¸è‚¯æ³¨é”€/$current_date"

# è®¾ç½®ç½‘ç›˜ç›®å½•
remote_directory="/BaiduPCS-Go/$current_date"

# éå†æ–‡ä»¶åˆ—è¡¨å¹¶ä¸Šä¼ 
count=1
for file in "$local_directory"/*; do
    # åªè·å–æ–‡ä»¶åç§°
    # filename=$(basename "$file")
    
    # ä¸Šä¼ æ–‡ä»¶
    echo "$count ä¸Šä¼ ä¸­ ğŸ„â€â™‚ï¸" 
    baidu-go upload "$file" "$remote_directory"
    echo -e "\n"

    ((count++))
    # åˆ é™¤å·²ä¸Šä¼ çš„æœ¬åœ°æ–‡ä»¶
    # rm "$local_file"
    # echo "åˆ é™¤æœ¬åœ°æ–‡ä»¶ï¼š$local_file"
done

echo "æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æˆåŠŸ âœ… âœ… âœ…"
exit 0
```

è¡¥å……å°çŸ¥è¯†ï¼Œä½¿ç”¨ scp å°†æœåŠ¡å™¨æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°

```bash
scp [æœåŠ¡ç”¨æˆ·å]@[æœåŠ¡å™¨åŸŸåæˆ– IP åœ°å€]:[æ–‡ä»¶æˆ–ç›®å½•ä½ç½®] [æœ¬åœ°æ–‡ä»¶æˆ–ç›®å½•ä½ç½®]

# æ–‡ä»¶
scp root@fenglive.icu:/home/feng/config/upload-baidu-go.sh upload.sh

# ç›®å½•
scp -r root@fenglive.icu:/home/feng/config/baidu-upload-sh/ baidu-upload-sh/
```

## é…ç½®å½•åˆ¶è§†é¢‘çš„ä¿å­˜è·¯å¾„æ¨¡æ¿ âœ…

è·¯å¾„ï¼šç›´æ’­å¹³å°/ä¸»æ’­åå­—/æ—¥æœŸ/æ—¶é—´ + æˆ¿é—´åå­—.flv

```bash
out_put_tmpl: '{{ .Live.GetPlatformCNName }}/{{ .HostName }}/{{ now | date "2006-01-02" }}/{{ now | date "15-04" }}_{{ .RoomName | filenameFilter }}.flv'
```

## å°† shell è„šæœ¬æŒ‚åå°è¿è¡Œ âœ…

run.sh

```bash
time=$(date "+%Y-%m-%d_%H-%M")

nohup ./upload.sh > upload_$time.log &
```

æŒ‚èµ·ä¸€ä¸ªåå°è„šæœ¬ä»»åŠ¡

```bash
./run.sh
```

æŸ¥çœ‹ä»»åŠ¡è¿›ç¨‹ IDï¼ˆé€šè¿‡ -v æ¥è¿‡æ»¤ grep æœ¬èº«çš„æŸ¥è¯¢è¿›ç¨‹ï¼‰

```bash
ps aux | grep -v "grep" | grep upload.sh
```
